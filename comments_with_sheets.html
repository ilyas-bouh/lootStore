<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Comments (Google Sheets sync)</title>
  <style>
    :root{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    body{max-width:900px;margin:40px auto;padding:20px;color:#0b1220}
    h1{font-size:1.6rem;margin-bottom:6px}
    p.lead{color:#374151;margin-top:0}
    .card{border:1px solid #e6e9ef;padding:16px;border-radius:12px;background:#fff}
    textarea{width:100%;min-height:100px;padding:10px;font-size:14px;border-radius:8px;border:1px solid #d1d5db}
    button{cursor:pointer;padding:8px 12px;border-radius:8px;border:0;background:#2563eb;color:#fff}
    .muted{color:#6b7280;font-size:13px}
    .controls{display:flex;gap:8px;margin-top:8px;align-items:center}
    .status{font-size:13px;color:#111827}
    #comments{margin-top:18px;display:flex;flex-direction:column;gap:10px}
    .comment{padding:10px;border-radius:10px;border:1px solid #eef2ff;background:#f8fafc}
    .meta{font-size:12px;color:#6b7280}
    .auth-buttons{display:flex;gap:8px}
    .small{font-size:12px;padding:6px 10px}
  </style>
</head>
<body>
  <h1>Comments — sync to Google Sheets</h1>
  <p class="lead">Type something below and click <strong>Post</strong>. Comments are synced to a Google Sheet (you must provide API keys / enable the Sheets API). There's also a local fallback.</p>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
      <div>
        <div class="muted">Google account:</div>
        <div id="user-email" class="status">Not signed in</div>
      </div>
      <div class="auth-buttons">
        <button id="signin" class="small">Sign in</button>
        <button id="signout" class="small" style="display:none;background:#ef4444">Sign out</button>
      </div>
    </div>

    <hr style="margin:12px 0;border:none;border-top:1px solid #eef2ff" />

    <label for="comment">Your comment</label>
    <textarea id="comment" placeholder="Write something honest... no bootlicking"></textarea>
    <div class="controls">
      <button id="post">Post</button>
      <div class="muted">Automatic sync to Google Sheets (if signed in). Local fallback: browser storage.</div>
    </div>

    <div id="statusLine" class="muted" style="margin-top:8px">Status: idle</div>

    <div id="comments">
      <!-- comments show here -->
    </div>
  </div>

  <script>
  /*
    IMPORTANT: to make this work you MUST:
      1) Create credentials in Google Cloud Console (OAuth Client ID for Web Application) and an API Key.
      2) Enable the Google Sheets API for your project.
      3) Replace the placeholders below: CLIENT_ID, API_KEY, SPREADSHEET_ID, SHEET_NAME.
      4) Add the origin where you'll host this file to the OAuth consent's Authorized JavaScript origins.

    This sample uses the gapi client library for OAuth + Sheets API calls.
    If you don't want Google sync, this page still works using localStorage as a fallback.
  */

  // ---------- CONFIGURE HERE ----------
  const CLIENT_ID = 'REPLACE_WITH_YOUR_CLIENT_ID.apps.googleusercontent.com';
  const API_KEY = 'REPLACE_WITH_YOUR_API_KEY';
  const SPREADSHEET_ID = 'REPLACE_WITH_YOUR_SPREADSHEET_ID';
  const SHEET_NAME = 'Comments'; // the sheet/tab name where rows will be appended
  // -------------------------------------

  const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

  // tiny helper UI
  const statusLine = document.getElementById('statusLine');
  const userEmailEl = document.getElementById('user-email');
  const signinBtn = document.getElementById('signin');
  const signoutBtn = document.getElementById('signout');
  const postBtn = document.getElementById('post');
  const commentInput = document.getElementById('comment');
  const commentsEl = document.getElementById('comments');

  // load gapi script dynamically
  function loadGapi() {
    return new Promise((resolve, reject) => {
      if (window.gapi) return resolve(window.gapi);
      const s = document.createElement('script');
      s.src = 'https://apis.google.com/js/api.js';
      s.onload = () => {
        gapi.load('client:auth2', () => resolve(gapi));
      };
      s.onerror = reject;
      document.head.appendChild(s);
    });
  }

  // initialize client when possible
  async function initClient() {
    try {
      await loadGapi();
      await gapi.client.init({ apiKey: API_KEY, clientId: CLIENT_ID, discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"], scope: SCOPES });
      updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
      gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
    } catch (e) {
      console.warn('gapi init failed', e);
      statusLine.textContent = 'Google API not initialized — using local-only mode.';
    }
  }

  function updateSigninStatus(isSignedIn) {
    if (isSignedIn) {
      const user = gapi.auth2.getAuthInstance().currentUser.get();
      const profile = user.getBasicProfile();
      userEmailEl.textContent = profile.getEmail();
      signinBtn.style.display = 'none';
      signoutBtn.style.display = 'inline-block';
      statusLine.textContent = 'Signed in. Comments will sync to Google Sheets.';
      loadCommentsFromSheet();
    } else {
      userEmailEl.textContent = 'Not signed in';
      signinBtn.style.display = 'inline-block';
      signoutBtn.style.display = 'none';
      statusLine.textContent = 'Not signed in. Using local-only mode unless you sign in.';
      loadCommentsFromLocal();
    }
  }

  signinBtn.addEventListener('click', async () => {
    if (!window.gapi) { statusLine.textContent = 'Google API not loaded.'; return; }
    statusLine.textContent = 'Signing in...';
    try { await gapi.auth2.getAuthInstance().signIn(); } catch (e) { console.warn(e); statusLine.textContent = 'Sign-in failed.'; }
  });

  signoutBtn.addEventListener('click', async () => {
    await gapi.auth2.getAuthInstance().signOut();
    statusLine.textContent = 'Signed out.';
  });

  postBtn.addEventListener('click', async () => {
    const text = commentInput.value.trim();
    if (!text) return;
    const timestamp = new Date().toISOString();
    const row = [timestamp, text];

    // optimistic UI
    prependComment({timestamp, text, local: true});
    commentInput.value = '';

    // attempt to write to sheets
    if (window.gapi && gapi.auth2 && gapi.auth2.getAuthInstance().isSignedIn.get()) {
      try {
        statusLine.textContent = 'Syncing to Google Sheets...';
        await appendRowToSheet(row);
        statusLine.textContent = 'Synced to Google Sheets.';
      } catch (e) {
        console.warn('append failed', e);
        statusLine.textContent = 'Failed to sync to Sheets; saved locally.';
        saveRowLocal(row);
      }
    } else {
      saveRowLocal(row);
      statusLine.textContent = 'Saved locally (not signed in).';
    }
  });

  function prependComment({timestamp, text, local=false}){
    const el = document.createElement('div');
    el.className = 'comment';
    el.innerHTML = `<div class="meta">${new Date(timestamp).toLocaleString()} ${local?'<span style="color:#9ca3af">(local)</span>':''}</div><div style="margin-top:6px">${escapeHtml(text)}</div>`;
    commentsEl.prepend(el);
  }

  // escape html
  function escapeHtml(str){ return str.replace(/[&<>"']/g, ch=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\' : '&#39;' }[ch])); }

  // LOCAL STORAGE fallback
  const LOCAL_KEY = 'comments_local_v1';
  function saveRowLocal(row){
    const stored = JSON.parse(localStorage.getItem(LOCAL_KEY) || '[]');
    stored.push(row);
    localStorage.setItem(LOCAL_KEY, JSON.stringify(stored));
  }
  function loadCommentsFromLocal(){
    commentsEl.innerHTML = '';
    const stored = JSON.parse(localStorage.getItem(LOCAL_KEY) || '[]');
    const rows = stored.slice().reverse();
    rows.forEach(r=>prependComment({timestamp:r[0], text:r[1], local:true}));
  }

  // SHEETS API interactions
  async function appendRowToSheet(row){
    if (!SPREADSHEET_ID || SPREADSHEET_ID.startsWith('REPLACE')) throw new Error('Spreadsheet ID not set in config');
    const params = { spreadsheetId: SPREADSHEET_ID, range: `${SHEET_NAME}!A:B`, valueInputOption: 'RAW' };
    const valueRangeBody = { values: [row] };
    const request = gapi.client.sheets.spreadsheets.values.append(params, valueRangeBody);
    return request.then(r=>r.result);
  }

  async function loadCommentsFromSheet(){
    commentsEl.innerHTML = '';
    try{
      if (!SPREADSHEET_ID || SPREADSHEET_ID.startsWith('REPLACE')) throw new Error('Spreadsheet ID not set in config');
      const response = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: `${SHEET_NAME}!A2:B` });
      const values = response.result.values || [];
      // newest first
      values.reverse().forEach(r => {
        const [ts, text] = r;
        prependComment({timestamp:ts || new Date().toISOString(), text: text || ''});
      });
      // merge any local unsynced rows
      const local = JSON.parse(localStorage.getItem(LOCAL_KEY) || '[]');
      if (local.length) {
        statusLine.textContent = `You have ${local.length} local comments. Attempting to sync...`;
        for (const r of local) {
          try { await appendRowToSheet(r); } catch(e){ console.warn('sync local failed', e); break; }
        }
        localStorage.removeItem(LOCAL_KEY);
        statusLine.textContent = 'Local comments synced.';
        // reload to show newly synced content
        const resp2 = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: `${SHEET_NAME}!A2:B` });
        const vals2 = resp2.result.values || [];
        commentsEl.innerHTML = '';
        vals2.reverse().forEach(r => prependComment({timestamp:r[0], text:r[1]}));
      }
    } catch (e) {
      console.warn('failed to load sheet', e);
      statusLine.textContent = 'Failed to read sheet — showing local comments.';
      loadCommentsFromLocal();
    }
  }

  // small helper to ensure there's a header row (optional)
  async function ensureHeaderRow(){
    try{
      const resp = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: `${SHEET_NAME}!A1:B1` });
      const v = resp.result.values || [];
      if (!v.length || (v[0][0] !== 'timestamp' || v[0][1] !== 'comment')){
        await gapi.client.sheets.spreadsheets.values.update({ spreadsheetId: SPREADSHEET_ID, range: `${SHEET_NAME}!A1:B1`, valueInputOption: 'RAW' }, { values: [['timestamp','comment']] });
      }
    } catch (e) { console.warn('ensure header failed', e); }
  }

  // init flow
  (async ()=>{
    // try to init gapi but still allow local-only use
    await initClient();

    // if gapi loaded and signed in, ensure header
    if (window.gapi && gapi.auth2 && gapi.auth2.getAuthInstance().isSignedIn.get()){
      try{ await ensureHeaderRow(); } catch(e){}
    }

    // initial load depending on auth
    if (window.gapi && gapi.auth2 && gapi.auth2.getAuthInstance().isSignedIn.get()){
      loadCommentsFromSheet();
    } else {
      loadCommentsFromLocal();
    }

  })();

  </script>
</body>
</html>
